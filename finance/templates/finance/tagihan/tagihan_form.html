{% extends 'finance/base.html' %} {% load humanize %} {% block content %}
<div class="container-fluid px-4">
  <h1 class="mt-4 mb-4">Buat Tagihan Baru</h1>

  <div class="card shadow mb-4">
    <div class="card-header py-3 bg-primary text-white">
      <h6 class="m-0 fw-bold">Pilih Transaksi untuk Ditagihkan</h6>
    </div>
    <div class="card-body">
      <form method="post" id="tagihanForm">
        {% csrf_token %}

        <div class="row mb-4">
          <div class="col-md-6">
            <label for="customerInput" class="form-label fw-bold">Nama Customer/Vendor</label>
            <input type="text" name="customer" id="customerInput" class="form-control" placeholder="Ketik nama customer atau pilih dari daftar item" required />
            <div class="form-text text-muted">Ketik manual atau akan otomatis terisi dari item pertama yang dicentang.</div>
          </div>
          <div class="col-md-4">
            <label for="jatuhTempo" class="form-label fw-bold">Tanggal Jatuh Tempo</label>
            <input type="date" name="jatuh_tempo" id="jatuhTempo" class="form-control" />
          </div>
          <div class="col-md-2">
            <label class="form-label fw-bold">Filter</label>
            <select id="filterVendor" class="form-select" onchange="filterByVendor()">
              <option value="">-- Semua --</option>
              {% for c in customers %}
              <option value="{{ c }}">{{ c }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead>
              <tr class="table-light">
                <th class="text-center" style="width: 50px"><input type="checkbox" id="checkAll" onclick="toggleAll(this)" /></th>
                <th>Tanggal</th>
                <th>No Resi</th>
                <th>Tujuan</th>
                <th>Customer</th>
                <th class="text-end">Total (Rp)</th>
              </tr>
            </thead>
            <tbody id="inboundTableBody">
              {% for item in inbounds %}
              <tr class="inbound-row" data-vendor="{{ item.vendor }}">
                <td class="text-center">
                  <input type="checkbox" name="inbound_ids" value="{{ item.pk }}" class="inbound-check" onchange="updateCustomerField()" />
                </td>
                <td>{{ item.tanggal_masuk_stt|date:"d/m/Y" }}</td>
                <td class="fw-bold">{{ item.no_resi }}</td>
                <td>{{ item.tujuan }}</td>
                <td><span class="badge bg-secondary">{{ item.vendor }}</span></td>
                <td class="text-end fw-bold">{{ item.total_biaya|intcomma }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center py-3">Tidak ada transaksi yang belum ditagih.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="mt-4 d-flex justify-content-between align-items-center">
          <div>
            <span class="text-muted">Terpilih: <strong id="selectedCount">0</strong> item</span>
            <span class="ms-3 text-primary fw-bold">Total: Rp <span id="selectedTotal">0</span></span>
          </div>
          <button type="submit" class="btn btn-success btn-lg"><i class="bi bi-file-earmark-plus"></i> Generate Invoice</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Filter by vendor (optional, for convenience)
  function filterByVendor() {
    const selectedVendor = document.getElementById('filterVendor').value;
    const rows = document.querySelectorAll('.inbound-row');

    rows.forEach((row) => {
      if (row.dataset.vendor === selectedVendor || selectedVendor === '') {
        row.style.display = '';
      } else {
        row.style.display = 'none';
        // Uncheck hidden items
        row.querySelector('.inbound-check').checked = false;
      }
    });

    // Uncheck 'check all' when filtering
    document.getElementById('checkAll').checked = false;
    updateCustomerField();
  }

  // Toggle all visible checkboxes
  function toggleAll(source) {
    const checkboxes = document.querySelectorAll('.inbound-row:not([style*="display: none"]) .inbound-check');
    checkboxes.forEach((cb) => (cb.checked = source.checked));
    updateCustomerField();
  }

  // Update customer field based on first checked item
  function updateCustomerField() {
    const checkedBoxes = document.querySelectorAll('.inbound-check:checked');
    const customerInput = document.getElementById('customerInput');

    if (checkedBoxes.length > 0) {
      // Get vendor from first checked item's row
      const firstRow = checkedBoxes[0].closest('.inbound-row');
      const vendor = firstRow.dataset.vendor;
      customerInput.value = vendor;
    } else {
      customerInput.value = '';
    }

    // Update count and total
    let count = 0;
    let total = 0;

    checkedBoxes.forEach((cb) => {
      count++;
      const row = cb.closest('tr');
      // Get total from last td (remove Rp and dots for parsing)
      const totalText = row.querySelector('td:last-child').textContent.trim();
      const numericVal = parseInt(totalText.replace(/\./g, '').replace(/,/g, '')) || 0;
      total += numericVal;
    });

    document.getElementById('selectedCount').textContent = count;
    document.getElementById('selectedTotal').textContent = total.toLocaleString('id-ID');
  }
</script>
{% endblock %}
