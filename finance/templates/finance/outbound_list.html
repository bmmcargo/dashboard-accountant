{% extends 'finance/base.html' %} {% load humanize %} {% block content %}
<div class="container-fluid px-4">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <h1 class="mt-4 mb-0"><i class="bi bi-box-arrow-up text-danger"></i> Laporan Outbound</h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
          <li class="breadcrumb-item active">Outbound</li>
        </ol>
      </nav>
    </div>
    <a href="{% url 'outbound_create' %}" class="btn btn-danger"> <i class="bi bi-plus-circle me-1"></i> Tambah Data </a>
  </div>

  <!-- Summary Cards -->
  <div class="row mb-3 mt-3">
    <div class="col-xl-3 col-md-6">
      <div class="card bg-danger text-white mb-3 shadow">
        <div class="card-body py-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-white-50 small">Total Transaksi</div>
              <div class="fs-4 fw-bold">{{ outbounds|length }} Resi</div>
            </div>
            <i class="bi bi-receipt fs-1 opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card bg-primary text-white mb-3 shadow">
        <div class="card-body py-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-white-50 small">Pendapatan (Rp)</div>
              <div class="fs-5 fw-bold">{{ total_pendapatan|intcomma }}</div>
            </div>
            <i class="bi bi-cash-coin fs-1 opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card bg-secondary text-white mb-3 shadow">
        <div class="card-body py-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-white-50 small">Biaya Vendor (Rp)</div>
              <div class="fs-5 fw-bold">{{ total_biaya_vendor|intcomma }}</div>
            </div>
            <i class="bi bi-truck fs-1 opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6">
      <div class="card bg-success text-white mb-3 shadow">
        <div class="card-body py-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-white-50 small">Profit (Rp)</div>
              <div class="fs-5 fw-bold">{{ total_profit|intcomma }}</div>
            </div>
            <i class="bi bi-graph-up-arrow fs-1 opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search Bar -->
  <div class="card shadow mb-3">
    <div class="card-body py-2">
      <form method="get" action="" class="row g-2 align-items-center">
        <div class="col-md-8">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" name="q" class="form-control" placeholder="Cari No Resi, Pengirim, Penerima..." value="{{ q }}" />
          </div>
        </div>
        <div class="col-md-4">
          <button type="submit" class="btn btn-danger me-2"><i class="bi bi-search"></i> Cari</button>
          {% if q %}
          <a href="{% url 'outbound_list' %}" class="btn btn-secondary"><i class="bi bi-x"></i> Reset</a>
          {% endif %}
        </div>
      </form>
    </div>
  </div>

  <!-- Tabel Data dengan Merged Headers -->
  <div class="card shadow mb-4">
    <div class="card-header py-2 bg-danger text-white">
      <h6 class="m-0 fw-bold"><i class="bi bi-table me-2"></i>LAPORAN OUTBOUND</h6>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-bordered table-hover table-sm mb-0" style="font-size: 0.8rem">
          <!-- Header Row 1 -->
          <thead>
            <tr class="table-dark text-center align-middle">
              <th rowspan="2" style="width: 35px">NO</th>
              <th rowspan="2" style="width: 70px">TGL</th>
              <th rowspan="2">PENGIRIM</th>
              <th rowspan="2">PENERIMA</th>
              <th rowspan="2" style="width: 70px">No Resi</th>
              <th rowspan="2" style="width: 35px">Koli</th>
              <th rowspan="2" style="width: 50px">KG</th>
              <th colspan="2" class="bg-warning text-dark">Harga BMM</th>
              <th colspan="3" class="bg-info">Vendor 1</th>
              <th colspan="3" class="bg-secondary">Vendor 2</th>
              <th rowspan="2">Ket</th>
              <th colspan="2" class="bg-success">Status</th>
              <th rowspan="2" class="bg-primary" style="width: 80px">Profit (Rp)</th>
              <th rowspan="2" style="width: 60px">Aksi</th>
            </tr>
            <tr class="table-secondary text-center" style="font-size: 0.75rem">
              <th class="bg-warning text-dark">Tarif</th>
              <th class="bg-warning text-dark">Total (Rp)</th>
              <th class="bg-info">Tgl</th>
              <th class="bg-info">No Resi</th>
              <th class="bg-info">Biaya (Rp)</th>
              <th class="bg-secondary">Tgl</th>
              <th class="bg-secondary">No Resi</th>
              <th class="bg-secondary">Biaya (Rp)</th>
              <th class="bg-success">Tgl</th>
              <th class="bg-success">Nama</th>
            </tr>
          </thead>
          <tbody>
            {% for item in outbounds %}
            <tr>
              <td class="text-center">{{ forloop.counter }}</td>
              <td class="text-nowrap">{{ item.tanggal|date:"d/m/y"|default:"-" }}</td>
              <td>{{ item.pengirim|default:"-"|truncatechars:18 }}</td>
              <td>{{ item.penerima|default:"-"|truncatechars:15 }}</td>
              <td class="fw-bold text-primary">{{ item.no_resi_bmm }}</td>
              <td class="text-center">{{ item.koli }}</td>
              <td class="text-end">{{ item.kg|default:"-" }}</td>
              <!-- Harga BMM -->
              <td class="text-end bg-warning-subtle">{{ item.tarif|default:"-" }}</td>
              <td class="text-end fw-bold bg-warning-subtle">{{ item.total|intcomma }}</td>
              <!-- Vendor 1 -->
              <td class="text-nowrap bg-info-subtle">{{ item.vendor1_tgl|date:"d/m/y"|default:"-" }}</td>
              <td class="bg-info-subtle">{{ item.vendor1_resi|default:"-"|truncatechars:12 }}</td>
              <td class="text-end text-danger bg-info-subtle">{% if item.vendor1_biaya %}{{ item.vendor1_biaya|intcomma }}{% else %}-{% endif %}</td>
              <!-- Vendor 2 -->
              <td class="text-nowrap bg-secondary-subtle">{{ item.vendor2_tgl|date:"d/m/y"|default:"-" }}</td>
              <td class="bg-secondary-subtle">{{ item.vendor2_resi|default:"-"|truncatechars:12 }}</td>
              <td class="text-end text-danger bg-secondary-subtle">{% if item.vendor2_biaya %}{{ item.vendor2_biaya|intcomma }}{% else %}-{% endif %}</td>
              <!-- Keterangan -->
              <td>
                {% if 'COD' in item.keterangan|default:""|upper %}
                <span class="badge bg-warning text-dark">COD</span>
                {% elif 'CASH' in item.keterangan|default:""|upper %}
                <span class="badge bg-success">CASH</span>
                {% elif 'TRANSFER' in item.keterangan|default:""|upper %}
                <span class="badge bg-primary">TRANSFER</span>
                {% else %} {{ item.keterangan|default:"-"|truncatechars:10 }} {% endif %}
              </td>
              <!-- Status -->
              <td class="text-nowrap bg-success-subtle">{{ item.tgl_bayar|date:"d/m/y"|default:"-" }}</td>
              <td class="bg-success-subtle">{{ item.nama_bayar|default:"-"|truncatechars:10 }}</td>
              <!-- Profit -->
              <td class="text-end fw-bold text-success bg-primary-subtle">{{ item.profit|intcomma }}</td>
              <!-- Aksi -->
              <td class="text-center text-nowrap">
                <a href="{% url 'outbound_edit' item.pk %}" class="btn btn-sm btn-warning py-0 px-1" title="Edit">
                  <i class="bi bi-pencil"></i>
                </a>
                <button type="button" class="btn btn-sm btn-danger py-0 px-1" title="Hapus" onclick="confirmDelete('{{ item.no_resi_bmm }}', '{% url 'outbound_delete' item.pk %}')">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="19" class="text-center py-4 text-muted">
                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                {% if q %}Tidak ada data yang cocok dengan "{{ q }}"{% else %}Belum ada data outbound.{% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <!-- Footer Totals -->
          <tfoot class="table-dark fw-bold">
            <tr>
              <td colspan="8" class="text-end">TOTAL:</td>
              <td class="text-end">{{ total_pendapatan|intcomma }}</td>
              <td colspan="2"></td>
              <td class="text-end text-danger">{{ total_biaya_vendor|intcomma }}</td>
              <td colspan="6"></td>
              <td class="text-end text-success">{{ total_profit|intcomma }}</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal Konfirmasi Delete -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel"><i class="bi bi-exclamation-triangle me-2"></i>Konfirmasi Hapus</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Apakah Anda yakin ingin menghapus data <strong id="deleteItemName"></strong>?</p>
        <p class="text-muted small mb-0">Tindakan ini tidak dapat dibatalkan.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <a id="deleteConfirmBtn" href="#" class="btn btn-danger">Ya, Hapus</a>
      </div>
    </div>
  </div>
</div>

<script>
  function confirmDelete(itemName, deleteUrl) {
    document.getElementById('deleteItemName').textContent = itemName;
    document.getElementById('deleteConfirmBtn').href = deleteUrl;
    var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
  }
</script>
{% endblock %}
